# flight_reader

Установите [uv](https://docs.astral.sh/uv/getting-started/installation/) 

Склонируйте репозиторий, далее создайте и активируйте вирутальное окружение

```
uv venv --python 3.13
source .venv/bin/activate
```

Установите проект (для разработчиков)

```
uv pip install -e .
```

Запуск сервера

```
frun
```

Документация по api:

http://127.0.0.1:8001/docs


## Настройки окружения

1. Скопируйте `.env.example` в `.env` и при необходимости измените значения.
2. Если используете Docker, дополнительно скопируйте `deployment/.env.example` в `deployment/.env`.


## Docker Compose

В каталоге `deployment` лежит конфигурация для запуска PostgreSQL:

1. Поднимите базу командой `docker compose -f deployment/docker-compose.yaml up -d`.
2. Проверьте состояние контейнера: `docker compose -f deployment/docker-compose.yaml ps`.
3. Скрипт `deployment/db-init/001_schema.sql` включает расширение PostGIS, создает все базовые таблицы (`flights`, `operators`, `regions`, `raw_messages`, `users`, `upload_logs`, `calculations`, `reports`) и наполняет справочники тестовыми данными.

## Архитектура базы данных

Основные сущности соответствуют требованиям ТЗ по хранению и аналитике полётов БАС:

- `flights` — факты полётов, связаны с операторами, типами БПЛА, регионами вылета/посадки и исходными сообщениями. Геометрия точек хранится в `geom_takeoff`/`geom_landing` как `GEOMETRY(Point, 4326)` с GiST‑индексами.
- `operators`, `uav_types`, `regions` — справочники с уникальными кодами. Для регионов хранится постGIS‑геометрия `MULTIPOLYGON`, позволяющая выполнять пространственные запросы `ST_Contains`/`ST_Intersects`.
- `raw_messages` — архив исходных SHR/DEP/ARR сообщений для аудита и повторных пересчётов.
- `users`, `upload_logs`, `calculations`, `reports` — аудит загрузок, on-demand вычислений и сохранённых отчётов. Поля параметров и содержимого отчётов размещаются в `JSONB`.
- `flights_history` — историзация изменений записей `flights`; наполнение предполагается триггерами или ETL.

Уникальные и пространственные индексы (создаются автоматом в ORM и SQL-скрипте) обеспечивают требования по дедупликации и скорости выборок. При необходимости можно включить партиционирование таблицы `flights` по дате вылета.

## REST API

После старта сервера доступны базовые эндпоинты:

- `GET /api/health/ping` — проверка состояния сервиса.
- `GET /api/map/regions` и `GET /api/map/regions/{code}` — справочник регионов в GeoJSON.
- `GET /api/flights` и `GET /api/flights/{id}` — выборка полётов с фильтрами по дате, оператору и типу БПЛА. Координаты возвращаются как широта/долгота.
- `POST /api/uploads/shr` — загрузка XLSX-файла (формат SHR) с указанием `user_id`. Файл сохраняется и обрабатывается в фоне: парсер извлекает сведения о полётах и пишет их в базу, журналируя результат в `upload_logs`.

Парсер SHR (`src/parser/parser.py`) выдаёт структурированные данные, которые можно конвертировать в объекты `Flight` и сохранять в БД.

### Пример загрузки XLSX через curl

```
curl -X POST \
     -F "user_id=1" \
     -F "file=@dataset/2024.xlsx" \
     http://127.0.0.1:8001/api/uploads/shr
```

В ответ вернётся идентификатор загрузки. Статус и количество импортированных полётов можно проверить в таблице `upload_logs` или добавив отдельный эндпоинт.
